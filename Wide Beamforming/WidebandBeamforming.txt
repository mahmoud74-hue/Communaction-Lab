% Wideband beamforming
clear; close all; clc;

%% Part A: time-delay beamforming (chirp + 10-element ULA)
c = 340; fs = 50e3;
t = linspace(0,1,fs)'; sig = chirp(t,0,1,1000);

mic1 = phased.OmnidirectionalMicrophoneElement('FrequencyRange',[20 20e3]);
array1 = phased.ULA('Element',mic1,'NumElements',10,'ElementSpacing',0.01);
collector = phased.WidebandCollector('Sensor',array1,'SampleRate',fs,'PropagationSpeed',c,'ModulatedInput',false);

sigang = [60;0];
rsig = collector(sig,sigang);
rsig = rsig + 0.1*randn(size(rsig));

tdbf = phased.TimeDelayBeamformer('SensorArray',array1,'SampleRate',fs,'PropagationSpeed',c,'Direction',sigang);
y_td = tdbf(rsig);

figure(1); clf;
subplot(2,1,1), plot(t(1:5000), real(rsig(1:5000,5))), axis([0 t(5000) -0.5 1]), title('Signal (real) at 5th element'), xlabel('Time (s)')
subplot(2,1,2), plot(t(1:5000), real(y_td(1:5000))), axis([0 t(5000) -0.5 1]), title('After Time-Delay Beamforming'), xlabel('Time (s)')
drawnow; pause(0.3);

%% Part B: element and array patterns (11-element cosine ULA)
freq = [1000 2750]; fc = 2000; numels = 11;
microphone = phased.CosineAntennaElement('FrequencyRange',[20 20e3]); % broad element range
d = 0.5 * c / fc;
array2 = phased.ULA('NumElements',numels,'ElementSpacing',d,'Element',microphone);

plotFreq = linspace(min(freq), max(freq), 15);
az = -180:180; el = 0;

% clip plotFreq to element range
elemRange = get(microphone,'FrequencyRange'); fmin = elemRange(1); fmax = elemRange(2);
validPlotFreq = plotFreq(plotFreq >= fmin & plotFreq <= fmax);
validPlotFreq = validPlotFreq(:).';

figure(2); clf;
pattern(microphone, validPlotFreq, az, el, 'CoordinateSystem','rectangular','PlotStyle','waterfall','Type','powerdb','PropagationSpeed',c);
title('Element Pattern (waterfall, power dB)'); drawnow; pause(0.2);

figure(3); clf;
pattern(array2, validPlotFreq, az, el, 'CoordinateSystem','rectangular','PlotStyle','waterfall','Type','powerdb','PropagationSpeed',c);
title('Array Pattern over Frequency'); drawnow; pause(0.2);

%% Part C: Subband Phase-Shift Beamformer (original-style)
direction = [30;0]; numbands = 8;
sbpf_sr = 1e3;   
sbpf = phased.SubbandPhaseShiftBeamformer('SensorArray',array2, ...
    'Direction',direction,'OperatingFrequency',fc,'PropagationSpeed',c, ...
    'SampleRate',sbpf_sr,'WeightsOutputPort',true,'SubbandsOutputPort',true,'NumSubbands',numbands);

rx = ones(numbands,numels);
[~, w, centerfreqs] = sbpf(rx);   % get weights and center freqs

% fftshift ordering to match original example
centerfreqs_shift = fftshift(centerfreqs);
w_shift = fftshift(w,2);

% ensure row vector for frequencies
centerfreqs_shift = centerfreqs_shift(:).';

% pick same indices used originally (guard against out-of-range)
idx = [1,5,8];
idx = idx(idx <= size(w_shift,2));

figure(4); clf;
% plot beamformed waterfall for all subbands (only those centerfreqs within element range used by pattern)
valid_cf = centerfreqs_shift;
pattern(array2, valid_cf, az, el, 'Weights', w_shift, 'CoordinateSystem','rectangular', 'PlotStyle','waterfall', 'Type','powerdb','PropagationSpeed',c);
title('Beamformed Array Pattern for Each Subband'); drawnow; pause(0.2);

figure(5); clf;
pattern(array2, centerfreqs_shift(idx), az, el, 'Weights', w_shift(:,idx), 'CoordinateSystem','rectangular', 'PlotStyle','overlay', 'Type','powerdb', 'PropagationSpeed', c);
legend('Location','South'); title('Overlay of Beamformed Patterns at 3 Subbands (orig selection)');
drawnow; pause(0.2);